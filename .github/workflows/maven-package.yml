name: Mulesoft RTF Reusable Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (dev, sit, uat, prd)'
        type: string
        required: true
        default: 'dev'
      pom_file_path:
        description: 'Path to the directory containing pom.xml'
        type: string
        required: false
        default: 'java/my-app'
      tag:
        description: 'Tag to deploy (required for uat/prd, ignored for dev/sit)'
        type: string
        required: false
        default: ''
      deploy_us:
        description: 'Deploy to US region'
        type: boolean
        required: false
        default: true
      deploy_eu:
        description: 'Deploy to EU region'
        type: boolean
        required: false
        default: true
      branch:
        description: 'Branch to deploy (for dev environment, feature-* branches skip tagging)'
        type: string
        required: false
        default: 'develop'

jobs:
  # Job 1: Package and Push to Anypoint Exchange
  package-and-publish:
    name: Package & Publish to Exchange
    runs-on: ubuntu-latest
    outputs:
      artifact-version: ${{ steps.extract-version.outputs.version }}
      artifact-name: ${{ steps.extract-version.outputs.name }}
    
    steps:
      - name: Validate tag for non-dev environments
        if: ${{ inputs.environment != 'dev' && inputs.tag == '' }}
        run: |
          echo "âŒ Error: Tag is required for non-dev environments"
          echo "Environment: ${{ inputs.environment }}"
          echo "Please provide a tag when deploying to sit, uat, or prd"
          exit 1
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.environment == 'dev' && inputs.branch || inputs.tag }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles(format('{0}/pom.xml', inputs.pom_file_path)) }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Validate pom.xml path
        run: |
          POM_DIR="${{ inputs.pom_file_path }}"
          if [ ! -f "$POM_DIR/pom.xml" ]; then
            echo "Error: pom.xml not found at $POM_DIR/pom.xml"
            exit 1
          fi
          echo "âœ“ Found pom.xml at $POM_DIR/pom.xml"
      
      - name: Extract artifact info
        id: extract-version
        run: |
          POM_DIR="${{ inputs.pom_file_path }}"
          VERSION=$(mvn -f $POM_DIR/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
          NAME=$(mvn -f $POM_DIR/pom.xml help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Artifact: $NAME-$VERSION"
      
      - name: Build with Maven
        run: |
          POM_DIR="${{ inputs.pom_file_path }}"
          cd $POM_DIR
          echo "ğŸ”¨ Building Mulesoft application..."
          mvn clean package -DskipTests=false
          echo "âœ“ Build complete"
      
      - name: Publish to Anypoint Exchange (Dry Run)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¤ PUBLISHING TO ANYPOINT EXCHANGE (DRY RUN)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Artifact: ${{ steps.extract-version.outputs.name }}"
          echo "Version:  ${{ steps.extract-version.outputs.version }}"
          echo "Environment: ${{ inputs.environment }}"
          echo ""
          echo "[DRY RUN] mvn deploy -DmuleDeploy -Danypoint.username=*** -Danypoint.password=***"
          echo ""
          echo "âœ“ Successfully published to Anypoint Exchange (simulated)"
          sleep 2
      
#      - name: Upload build artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: mulesoft-app-${{ steps.extract-version.outputs.version }}
#          path: ${{ inputs.pom_file_path }}/target/*.jar
#          retention-days: 5

  # Job 2: Deploy to US Region
  deploy-us:
    name: Deploy to US Region
    needs: package-and-publish
    if: ${{ inputs.deploy_us }}
    runs-on: ubuntu-latest
    environment: us-${{ inputs.environment }}
    
    steps:
      - name: Deploy to US CloudHub (Dry Run)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‡ºğŸ‡¸ DEPLOYING TO US REGION (DRY RUN)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Artifact: ${{ needs.package-and-publish.outputs.artifact-name }}"
          echo "Version:  ${{ needs.package-and-publish.outputs.artifact-version }}"
          echo "Region:   US"
          echo "Environment: us-${{ inputs.environment }}"
          echo "CloudHub Worker: us-east-1"
          echo ""
          echo "[DRY RUN] anypoint-cli runtime-mgr cloudhub-application deploy"
          echo "         --environment ${{ inputs.environment }}"
          echo "         --region us-east-1"
          echo "         --workers 1"
          echo "         --workerSize 0.1"
          echo ""
          echo "â³ Simulating deployment..."
          sleep 3
          echo "âœ“ Application deployed to US CloudHub (simulated)"
      
      - name: Verify US Deployment (Dry Run)
        run: |
          echo "ğŸ” Verifying US deployment..."
          echo "[DRY RUN] Checking application status..."
          sleep 2
          echo "âœ“ Application status: STARTED"
          echo "âœ“ Health check: PASSED"

  # Job 3: Deploy to EU Region
  deploy-eu:
    name: Deploy to EU Region
    needs: package-and-publish
    if: ${{ inputs.deploy_eu }}
    runs-on: ubuntu-latest
    environment: eu-${{ inputs.environment }}
    
    steps:
      - name: Deploy to EU CloudHub (Dry Run)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‡ªğŸ‡º DEPLOYING TO EU REGION (DRY RUN)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Artifact: ${{ needs.package-and-publish.outputs.artifact-name }}"
          echo "Version:  ${{ needs.package-and-publish.outputs.artifact-version }}"
          echo "Region:   EU"
          echo "Environment: eu-${{ inputs.environment }}"
          echo "CloudHub Worker: eu-west-1"
          echo ""
          echo "[DRY RUN] anypoint-cli runtime-mgr cloudhub-application deploy"
          echo "         --environment ${{ inputs.environment }}"
          echo "         --region eu-west-1"
          echo "         --workers 1"
          echo "         --workerSize 0.1"
          echo ""
          echo "â³ Simulating deployment..."
          sleep 3
          echo "âœ“ Application deployed to EU CloudHub (simulated)"
      
      - name: Verify EU Deployment (Dry Run)
        run: |
          echo "ğŸ” Verifying EU deployment..."
          echo "[DRY RUN] Checking application status..."
          sleep 2
          echo "âœ“ Application status: STARTED"
          echo "âœ“ Health check: PASSED"

  # Job 4: Backup to Nexus
  backup-to-nexus:
    name: Backup to Nexus
    needs: [package-and-publish, deploy-us, deploy-eu]
    if: ${{ always() && needs.package-and-publish.result == 'success' && inputs.environment == 'dev' && inputs.branch == 'develop'}}
    uses: ./.github/workflows/nexus-backup.yml
    with:
      artifact_name: ${{ needs.package-and-publish.outputs.artifact-name }}
      artifact_version: ${{ needs.package-and-publish.outputs.artifact-version }}
      environment: ${{ inputs.environment }}
      us_deployment_result: ${{ needs.deploy-us.result || 'skipped' }}
      eu_deployment_result: ${{ needs.deploy-eu.result || 'skipped' }}

  # Job 5: Tag Release (Dev and Prd only, skip for feature branches in dev)
  tag-release:
    name: Tag Release
    needs: [package-and-publish, deploy-us, deploy-eu]
    if: ${{ always() && (inputs.environment == 'dev' || inputs.environment == 'prd') && !(inputs.environment == 'dev' && startsWith(inputs.branch, 'feature-')) && needs.package-and-publish.result == 'success' && (needs.deploy-us.result == 'success' || needs.deploy-eu.result == 'success') }}
    uses: ./.github/workflows/tag-and-merge.yml
    with:
      release_type: ${{ inputs.environment == 'prd' && 'production' || 'dev' }}
      artifact_version: ${{ needs.package-and-publish.outputs.artifact-version }}
      artifact_name: ${{ needs.package-and-publish.outputs.artifact-name }}
      source_ref: ${{ inputs.environment == 'prd' && inputs.tag || inputs.branch }}
      merge_to_main: ${{ inputs.environment == 'prd' }}
