name: Update Maven Dependencies and Confluence

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      pom_file_path:
        description: 'Path to the directory containing pom.xml'
        required: false
        default: 'java/my-app'
      confluence_url:
        description: 'Confluence URL'
        required: false
        default: 'https://odoraf.atlassian.net/wiki'
      confluence_username:
        description: 'Confluence username/email'
        required: false
        default: 'poseidonog@gmail.com'
      confluence_page_id:
        description: 'Confluence page ID to update'
        required: false
        default: '393218'

jobs:
  update-dependencies-and-confluence:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Upgrade dependencies with Maven
        working-directory: ${{ inputs.pom_file_path || 'java/my-app' }}
        run: |
          cp pom.xml pom.xml.old
          mvn versions:display-property-updates
          mvn versions:update-properties -DallowMajorUpdates=false
          find . -name "*.versionsBackup" -delete
          cp pom.xml pom.xml.new
          cp pom.xml.old pom.xml
      
      - name: Parse dependency changes and generate outputs
        if: ${{ hashFiles(format('{0}/pom.xml.new', inputs.pom_file_path || 'java/my-app')) != '' }}
        env:
          POM_DIR: ${{ inputs.pom_file_path || 'java/my-app' }}
        run: |
          python3 << 'EOF'
          import xml.etree.ElementTree as ET
          from datetime import datetime
          import os
          import json
          
          # Get POM directory from environment
          pom_dir = os.environ.get('POM_DIR', 'java/my-app')
          
          def parse_pom_file(pom_file):
              """Parse POM file to extract dependencies and their versions."""
              deps = {}
              try:
                  tree = ET.parse(pom_file)
                  root = tree.getroot()
                  ns = {'maven': 'http://maven.apache.org/POM/4.0.0'}
                  
                  # First, extract all properties
                  properties = {}
                  properties_elem = root.find('.//maven:properties', ns)
                  if properties_elem is not None:
                      for prop in properties_elem:
                          # Remove namespace prefix from tag name
                          prop_name = prop.tag.replace('{http://maven.apache.org/POM/4.0.0}', '')
                          properties[prop_name] = prop.text
                  
                  def resolve_version(version_text):
                      """Resolve property references like ${property.name} to actual values."""
                      if version_text and version_text.startswith('${') and version_text.endswith('}'):
                          prop_name = version_text[2:-1]  # Remove ${ and }
                          return properties.get(prop_name, version_text)
                      return version_text
                  
                  # Parse dependencies
                  for dep in root.findall('.//maven:dependency', ns):
                      artifact_elem = dep.find('maven:artifactId', ns)
                      version_elem = dep.find('maven:version', ns)
                      group_elem = dep.find('maven:groupId', ns)
                      
                      if artifact_elem is not None and version_elem is not None:
                          artifact = artifact_elem.text
                          group = group_elem.text if group_elem is not None else ''
                          raw_version = version_elem.text
                          resolved_version = resolve_version(raw_version)
                          deps[artifact] = {
                              'groupId': group,
                              'version': resolved_version
                          }
                  
                  # Parse plugins
                  for plugin in root.findall('.//maven:plugin', ns):
                      artifact_elem = plugin.find('maven:artifactId', ns)
                      version_elem = plugin.find('maven:version', ns)
                      
                      if artifact_elem is not None and version_elem is not None:
                          artifact = artifact_elem.text
                          raw_version = version_elem.text
                          resolved_version = resolve_version(raw_version)
                          deps[artifact] = {
                              'groupId': 'org.apache.maven.plugins',
                              'version': resolved_version
                          }
              
              except Exception as e:
                  print(f"Error parsing POM file: {e}")
              
              return deps
          
          def compare_pom_files(old_pom, new_pom):
              """Compare two POM files and extract version changes."""
              old_deps = parse_pom_file(old_pom)
              new_deps = parse_pom_file(new_pom)
              
              changes = []
              
              for artifact, new_info in new_deps.items():
                  if artifact in old_deps:
                      old_version = old_deps[artifact]['version']
                      new_version = new_info['version']
                      
                      if old_version != new_version:
                          changes.append({
                              'artifact': artifact,
                              'groupId': new_info['groupId'],
                              'old_version': old_version,
                              'new_version': new_version
                          })
              
              return changes
          
          # Parse the changes
          changes = compare_pom_files(
              f'{pom_dir}/pom.xml.old',
              f'{pom_dir}/pom.xml.new'
          )
          
          print(f"Found {len(changes)} dependency updates")
          
          # Generate GitHub summary in Markdown
          summary = f"## Maven Dependency Updates - {datetime.now().strftime('%Y-%m-%d')}\n\n"
          summary += f"**Total updates: {len(changes)}**\n\n"
          
          for change in changes:
              summary += f"- **{change['artifact']}**: `{change['old_version']}` → `{change['new_version']}`\n"
          
          summary += "\n\n"
          
          # Write to GitHub step summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              f.write(summary)
          
          # Generate Confluence HTML content
          print("Generating Confluence HTML...")
          html_content = f"""<h2>Maven Dependency Updates - {datetime.now().strftime('%Y-%m-%d')}</h2>
          <p><strong>Total updates: {len(changes)}</strong></p>
          <ul>
          """
                    
          for change in changes:
              html_content += f"  <li><strong>{change['artifact']}</strong>: {change['old_version']} → {change['new_version']}</li>\n"
          
          html_content += "</ul>"
          
          # Save Confluence HTML to file
          with open('confluence-content.html', 'w') as f:
              f.write(html_content)
          print("✓ Confluence HTML created (confluence-content.html)")
          
          # Save changes as JSON for reference
          with open('changes.json', 'w') as f:
              json.dump(changes, f, indent=2)
          print("✓ Changes JSON created (changes.json)")
          
          print()
          print("=" * 80)
          print(f"✓ ALL OUTPUTS GENERATED SUCCESSFULLY ({len(changes)} updates)")
          print("=" * 80)
          EOF
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Update Confluence Page
        if: ${{ hashFiles(format('{0}/pom.xml.new', inputs.pom_file_path || 'java/my-app')) != '' }}
        env:
          CONFLUENCE_URL: ${{ inputs.confluence_url || secrets.CONFLUENCE_URL }}
          CONFLUENCE_USERNAME: ${{ inputs.confluence_username || secrets.CONFLUENCE_USERNAME }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_PAGE_ID: ${{ inputs.confluence_page_id || secrets.CONFLUENCE_PAGE_ID }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from requests.auth import HTTPBasicAuth
          
          # Confluence credentials
          confluence_url = os.environ.get('CONFLUENCE_URL')
          username = os.environ.get('CONFLUENCE_USERNAME')
          api_token = os.environ.get('CONFLUENCE_API_TOKEN')
          page_id = os.environ.get('CONFLUENCE_PAGE_ID')
          
          if not all([confluence_url, username, api_token, page_id]):
              print("Missing Confluence credentials. Skipping update.")
              exit(0)
          
          # Read the HTML content to append
          try:
              with open('confluence-content.html', 'r') as f:
                  new_content = f.read()
          except FileNotFoundError:
              print("Error: confluence-content.html not found!")
              exit(1)
          
          # Setup authentication and headers for v2 API
          auth = HTTPBasicAuth(username, api_token)
          headers = {'Content-Type': 'application/json'}
          
          # Get current page
          get_url = f"{confluence_url}/api/v2/pages/{page_id}?body-format=storage"
          response = requests.get(get_url, auth=auth, headers=headers)
          
          if response.status_code != 200:
              print(f"Failed to get page: {response.status_code}")
              print(response.text)
              exit(1)
          
          page_data = response.json()
          current_version = page_data['version']['number']
          current_content = page_data['body']['storage']['value']
          page_title = page_data['title']
          
          # Append new content to existing content (new at top with separator)
          updated_content = new_content + "\n<hr>\n" + current_content 
          
          # Update the page
          update_data = {
              "id": page_id,
              "status": "current",
              "title": page_title,
              "body": {
                  "representation": "storage",
                  "value": updated_content
              },
              "version": {
                  "number": current_version + 1,
                  "message": "Updated by GitHub Actions - Maven dependency updates"
              }
          }
          
          put_url = f"{confluence_url}/api/v2/pages/{page_id}"
          response = requests.put(put_url, auth=auth, headers=headers, json=update_data)
          
          if response.status_code == 200:
              print(f"✓ Confluence page updated: {confluence_url}/pages/viewpage.action?pageId={page_id}")
          else:
              print(f"Failed to update page: {response.status_code}")
              print(response.text)
              exit(1)
          EOF
