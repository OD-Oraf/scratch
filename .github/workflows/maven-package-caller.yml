name: Mulesoft RTF Deploy(Mock)

run-name: "Deploy ${{ inputs.environment }}${{ inputs.environment == 'dev' && format(' ({0})', inputs.branch) || format(' v{0}', inputs.tag) }} [${{ inputs.deploy_us && inputs.deploy_eu && 'US+EU' || inputs.deploy_us && 'US' || inputs.deploy_eu && 'EU' || 'None' }}]"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment (dev, sit, uat, prd)'
        type: choice
        options:
          - dev
          - sit
          - uat
          - prd
        required: true
        default: 'dev'
      pom_file_path:
        description: 'Path to the directory containing pom.xml'
        type: string
        required: false
        default: 'java/my-app'
      branch:
        description: 'Branch to deploy (dev only, feature-* branches skip tagging)'
        type: string
        required: false
        default: 'develop'
      tag:
        description: 'Tag to deploy (required for sit/uat/prd)'
        type: string
        required: false
        default: ''
      deploy_us:
        description: 'Deploy to US region'
        type: boolean
        required: false
        default: true
      deploy_eu:
        description: 'Deploy to EU region'
        type: boolean
        required: false
        default: true

jobs:
  test-github-app-token:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Test token with API call
        run: |
          echo "Token generated successfully"
          curl -H "Authorization: Bearer ${{ steps.generate-token.outputs.token }}" \
               -H "Accept: application/vnd.github+json" \
               https://api.github.com/repos/${{ github.repository }}

      - name: Configure git
        run: |
          git config user.name "github-app[bot]"
          git config user.email "${{ secrets.APP_ID }}+github-app[bot]@users.noreply.github.com"

      - name: Create test file and commit
        run: |
          echo "Test commit from GitHub App at $(date)" > test-github-app-commit.txt
          git add test-github-app-commit.txt
          git commit -m "Test commit via GitHub App token"

      - name: Push changes using GitHub App token
        run: |
          git remote set-url origin https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com/${{ github.repository }}.git
          git push origin ${{ github.ref_name }}

#  call-mulesoft-deploy:
#    permissions:
#      contents: write
#    uses: ./.github/workflows/maven-package.yml
#    with:
#      environment: ${{ inputs.environment }}
#      pom_file_path: ${{ inputs.pom_file_path }}
#      branch: ${{ inputs.branch }}
#      tag: ${{ inputs.tag }}
#      deploy_us: ${{ inputs.deploy_us }}
#      deploy_eu: ${{ inputs.deploy_eu }}
#    secrets: inherit
